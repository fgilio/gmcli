<!-- Auto-generated by Codex CLI. Review and customize as needed. -->

# CLI Skill Validation Specification

Validation checklist for PHP CLI skills built with `php-cli-builder` and `agent-skill-foundation`.

---

## Core CLI Contract (MUST)

These are the non-negotiable requirements for AI-agent-safe CLI skills:

### 1. No-Hang Guarantee
- `--help` must complete in <2 seconds
- `--help` must never prompt for input
- Unknown commands must complete quickly

### 2. Unknown Command Contract
- `skill __nope__` exits non-zero with human error
- `skill __nope__ --json` exits non-zero with valid JSON to stderr:
  ```json
  {"error": "Unknown command: __nope__", "valid_commands": ["search", "show", ...]}
  ```

### 3. Lenient Parsing
- `skill __nope__ --json --some-flag=1` must NOT fail with Symfony "option does not exist"
- Requires `ignoreValidationErrors()` in `DefaultCommand::configure()`

### 4. JSON Purity
- When `--json` is present, no ANSI escape codes in output
- Success data goes to stdout, errors go to stderr

### 5. Exit Codes
- 0 = success (including empty results)
- Non-zero = failure

---

## Commands Available

Top-level routing (from `DefaultCommand.php`):

### Account Management
- `gmcli accounts credentials <file.json>`: Set OAuth credentials
- `gmcli accounts list`: List configured accounts
- `gmcli accounts add <email> [--manual]`: Add account (browserless OAuth with `--manual`)
- `gmcli accounts remove <email>`: Remove account

### Gmail Operations
Email is optional when a default account exists. You can call commands as:
- `gmcli <email> <command> [options]`
- `gmcli <command> [options]` (uses default email from `~/.gmcli/.env`)

Commands:
- `gmcli <email> search <query> [--max N] [--page TOKEN]`
- `gmcli <email> thread <threadId> [--download]`
- `gmcli <email> labels list`
- `gmcli <email> labels <threadIds...> [--add L] [--remove L]`
- `gmcli <email> drafts list`
- `gmcli <email> drafts get <draftId> [--download]`
- `gmcli <email> drafts delete <draftId>`
- `gmcli <email> drafts send <draftId>`
- `gmcli <email> drafts create --to <emails> --subject <s> --body <b> [--cc] [--bcc] [--reply-to] [--attach <file>...]`
- `gmcli <email> send --to <emails> --subject <s> --body <b> [--cc] [--bcc] [--reply-to] [--attach <file>...]`
- `gmcli <email> url <threadIds...>`

Notes:
- `search` accepts Gmail query syntax; `--max` defaults to 20 when omitted.
- `labels` accepts label names or IDs; names are case-insensitive.
- `--download` writes attachments to `~/.gmcli/attachments/`.
- `--attach` can be repeated to add multiple files.

---

## File Structure

- [ ] `SKILL.md` with valid frontmatter (`name`, `description`)
- [ ] `SPEC.md` (design decisions, commands, data schema)
- [ ] `SETUP.md` (global installation instructions)
- [ ] `ANALYTICS.md` (analytics documentation)
- [ ] `README.md` (user quick-start)
- [ ] `install` script (executable, symlinks binary to PATH)
- [ ] `.gitignore` (excludes `analytics.jsonl`, `.env`, `src/vendor/`)

---

## Skill-Specific Details

### Default Email Resolution
- If the first argument is an email (`@` + `.`), it is treated as the account.
- If omitted, gmcli reads `GMAIL_ADDRESS` from `~/.gmcli/.env`.
- If no default email exists, gmcli errors with guidance to add an account.

### JSON Output
- `--json` enables structured output.
- Errors are written to stderr as `{ "error": "..." }`.
- Unknown command errors include `valid_commands` from the Gmail command list.

### Data Storage
- `~/.gmcli/.env`: OAuth credentials and account token
- `~/.gmcli/attachments/`: Downloaded attachments
- `.env` next to binary: shared OAuth credentials (optional)

---

## CLI Contract Validation

These checks validate the runtime contract:

```bash
# Unknown command exits non-zero
gmcli __nope__
echo $?  # should be non-zero

# Unknown command with --json returns valid JSON to stderr
gmcli __nope__ --json 2>&1 | jq .error
# should output "Unknown command: __nope__"

# Lenient parsing works
gmcli __nope__ --json --some-flag=1 2>&1 | jq .error
# should still return JSON, not Symfony error

# JSON purity
gmcli --help --json | cat -v
# should not contain ^[[ (ANSI escape)
```

---

## Related

- [php-cli-builder](../php-cli-builder/SKILL.md) - Build toolchain
- [skill-design-philosophy](../skill-design-philosophy/SKILL.md) - Design principles
